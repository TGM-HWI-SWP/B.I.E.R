{% extends "base.html" %}
{% block title %}Produktverwaltung — B.I.E.R{% endblock %}

{% block content %}
<div class="page-content">

  <!-- ─── Page Header ──────────────────────────────────── -->
  <div class="section-header" style="margin-bottom:28px;">
    <div>
      <h1 class="page-title">Produktverwaltung</h1>
      <p class="page-subtitle">
        {{ produkte | length }} Produkt{% if produkte | length != 1 %}e{% endif %} gespeichert
        {% if active_lager_filter %}
          <span class="badge badge-accent">Filter: {{ active_lager_filter.lagername }}</span>
        {% endif %}
      </p>
    </div>
    <a href="{{ url_for('page2_product_edit') }}" class="btn btn-primary btn-lg" id="addProductBtn">
      <i class="bi bi-plus-lg"></i> Neues Produkt
    </a>
  </div>

  <!-- ─── Search ───────────────────────────────────────── -->
  <div class="card" style="margin-bottom:20px; padding:20px;">
    <div class="autocomplete-wrap">
      <div style="position:relative;">
        <i class="bi bi-search" style="position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:17px;pointer-events:none;"></i>
        <input
          type="text"
          id="searchInput"
          class="form-control"
          placeholder="Produkt suchen…"
          autocomplete="off"
          style="padding-left:46px; font-size:15px; height:50px; border-radius:10px;"
        />
      </div>
      <div class="autocomplete-list" id="autocompleteList">
        {% for p in produkte %}
          <div class="autocomplete-item" data-id="{{ p._id }}" data-name="{{ p.name }}"
               onclick="openProduct('{{ p._id }}')">
            <i class="bi bi-box"></i>
            <div>
              <div style="font-weight:500;">{{ p.name }}</div>
              <div class="item-id">ID: {{ p._id }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ─── Product List ─────────────────────────────────── -->
  <div class="card" style="padding:0; overflow:hidden;">
    <div style="max-height:calc(100vh - 340px); overflow-y:auto;" id="productListContainer">
      {% if produkte %}
        <table class="data-table" id="productTable">
          <thead>
            <tr>
              <th style="width:40px;">#</th>
              <th>Produktname</th>
              <th>Beschreibung</th>
              <th>Gewicht</th>
              <th style="width:120px; text-align:right;">Aktion</th>
            </tr>
          </thead>
          <tbody>
            {% for p in produkte %}
            <tr class="product-row" data-name="{{ p.name | lower }}" data-id="{{ p._id }}"
                style="cursor:pointer;"
                onclick="openProduct('{{ p._id }}')">
              <td style="color:var(--text-muted); font-size:13px;">{{ loop.index }}</td>
              <td>
                <div style="font-weight:600;">{{ p.name }}</div>
              </td>
              <td style="color:var(--text-muted);">
                {{ p.beschreibung if p.beschreibung else '—' }}
              </td>
              <td>
                {% if p.gewicht is defined and p.gewicht is not none %}
                  <span class="badge badge-muted">{{ p.gewicht }} kg</span>
                {% else %}
                  <span style="color:var(--text-muted);">—</span>
                {% endif %}
              </td>
              <td style="text-align:right;" onclick="event.stopPropagation();">
                <button type="button" class="btn btn-secondary btn-sm" title="In anderes Lager verschieben"
                        onclick="openMoveModal('{{ p._id }}', '{{ p.name | e }}', {{ p.menge | default(0) }}, '{{ p.lager_id | default('') }}')">
                  <i class="bi bi-arrow-left-right"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty-state">
          <i class="bi bi-box-seam"></i>
          <p>Noch keine Produkte vorhanden.</p>
          <a href="{{ url_for('page2_product_edit') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Erstes Produkt anlegen
          </a>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<!-- ─── Move Product Modal ───────────────────────── -->
<div class="modal-overlay" id="moveModal">
  <div class="modal-box" style="text-align:left;max-width:480px;">
    <h3 style="margin-bottom:16px;display:flex;align-items:center;gap:10px;">
      <i class="bi bi-arrow-left-right" style="color:var(--accent);"></i>
      Produkt in anderes Lager verschieben
    </h3>
    <p id="moveModalInfo" style="color:var(--text-muted);font-size:13px;margin-bottom:16px;"></p>
    <form method="POST" id="moveForm">
      <input type="hidden" name="source_lager_id" value="">
      <div style="margin-bottom:14px;">
        <label class="form-label">Ziel-Lager *</label>
        <select name="target_lager_id" class="form-select" required>
          <option value="">Lager auswählen…</option>
          {% for l in lager %}
            <option value="{{ l._id }}">{{ l.lagername }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="margin-bottom:20px;">
        <label class="form-label">Menge *</label>
        <input type="number" name="menge" class="form-control" min="1" value="1" required />
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" class="btn btn-secondary" onclick="closeMoveModal()">Abbrechen</button>
        <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg"></i> Verschieben</button>
      </div>
    </form>
  </div>
</div>

<!-- ─── No unsaved changes modal needed on this page ── -->
{% endblock %}

{% block extra_scripts %}
<script>
  const searchInput       = document.getElementById('searchInput');
  const autocompleteList  = document.getElementById('autocompleteList');
  const productRows       = document.querySelectorAll('.product-row');
  let acHighlight = -1;

  function openProduct(id) {
    window.location = '/ui/produkt/' + id + '/bearbeiten';
  }

  // ── Live search filter ─────────────────────────────────────
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim().toLowerCase();
    acHighlight = -1;

    // Filter table rows
    productRows.forEach(row => {
      const match = row.dataset.name.includes(q);
      row.style.display = match ? '' : 'none';
    });

    // Autocomplete list
    const items = autocompleteList.querySelectorAll('.autocomplete-item');
    let anyVisible = false;
    items.forEach(item => {
      const match = item.dataset.name.toLowerCase().includes(q);
      item.style.display = match ? '' : 'none';
      if (match) anyVisible = true;
    });
    autocompleteList.classList.toggle('open', q.length > 0 && anyVisible);
    applyHighlight();
  });

  // ── Keyboard navigation ────────────────────────────────────
  searchInput.addEventListener('keydown', e => {
    const items = [...autocompleteList.querySelectorAll('.autocomplete-item:not([style*="display: none"])')];
    if (e.key === 'ArrowDown') {
      acHighlight = Math.min(acHighlight + 1, items.length - 1);
      applyHighlight(); e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      acHighlight = Math.max(acHighlight - 1, -1);
      applyHighlight(); e.preventDefault();
    } else if (e.key === 'Enter' && acHighlight >= 0) {
      items[acHighlight]?.click(); e.preventDefault();
    } else if (e.key === 'Escape') {
      autocompleteList.classList.remove('open');
    }
  });

  function applyHighlight() {
    const items = [...autocompleteList.querySelectorAll('.autocomplete-item:not([style*="display: none"])')];
    items.forEach((item, i) => item.classList.toggle('highlighted', i === acHighlight));
  }

  // Close autocomplete on outside click
  document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !autocompleteList.contains(e.target)) {
      autocompleteList.classList.remove('open');
    }
  });

  // ── Move modal ─────────────────────────────────────────
  function openMoveModal(id, name, available, currentLagerId) {
    const overlay = document.getElementById('moveModal');
    const info    = document.getElementById('moveModalInfo');
    const form    = document.getElementById('moveForm');
    if (!overlay || !info || !form) return;

    info.textContent = `Produkt "${name}" verschieben. Verfügbare Menge: ${available} Stk.`;
    form.action = `/ui/produkt/${id}/verschieben`;

    // Quell-Lager im versteckten Feld speichern (für Mehrlager-Szenario)
    const sourceField = form.querySelector('input[name="source_lager_id"]');
    if (sourceField) {
      sourceField.value = currentLagerId || '';
    }

    // Reset fields
    const select = form.querySelector('select[name="target_lager_id"]');
    if (select) {
      // Alle Optionen anzeigen und dann aktuelles Lager ausblenden
      [...select.options].forEach(opt => { opt.hidden = false; opt.disabled = false; });
      if (currentLagerId) {
        [...select.options].forEach(opt => {
          if (opt.value === currentLagerId) {
            opt.hidden = true;
            opt.disabled = true;
          }
        });
      }
      select.value = '';
    }
    form.menge.value = available > 0 ? 1 : 0;

    overlay.classList.add('open');
  }

  function closeMoveModal() {
    const overlay = document.getElementById('moveModal');
    if (overlay) overlay.classList.remove('open');
  }

  document.getElementById('moveModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) {
      closeMoveModal();
    }
  });
</script>
{% endblock %}
