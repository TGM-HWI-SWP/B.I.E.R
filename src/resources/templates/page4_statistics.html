{% extends "base.html" %}
{% block title %}Statistik — B.I.E.R{% endblock %}

{% block extra_head %}
<style>
  .stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .stat-card .stat-icon {
    font-size: 22px;
    color: var(--accent);
    margin-bottom: 4px;
  }
  .stat-card .stat-value {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -.5px;
  }
  .stat-card .stat-label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: .07em;
  }

  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
  }
  @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .chart-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    display: flex; align-items: center; gap: 8px;
  }
  .chart-title i { color: var(--accent); }
  .chart-container {
    position: relative;
    height: 280px;
  }

  .top-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-height: 380px;
    overflow-y: auto;
    padding-right: 4px;
  }
  .top-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px 16px;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    transition: background var(--transition);
  }
  .top-item:hover { background: var(--surface-3); }
  .top-rank {
    width: 28px; height: 28px;
    border-radius: 50%;
    background: var(--surface-3);
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700;
    color: var(--text-muted);
    flex-shrink: 0;
  }
  /* Platz 1 = Gold, 2 = Silber, 3 = Bronze */
  .top-rank.rank-1 { background: #facc15; color: #92400e; }
  .top-rank.rank-2 { background: #e5e7eb; color: #4b5563; }
  .top-rank.rank-3 { background: #fed7aa;  color: #9a3412; }
  .top-item-name {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
  }
  .top-item-val {
    font-size: 15px;
    font-weight: 700;
    color: var(--accent);
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
    padding: 16px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  .filter-bar label { font-size: 13px; color: var(--text-muted); font-weight: 500; }
</style>
{% endblock %}

{% block content %}
<div class="page-content">

  <!-- ─── Page Header ──────────────────────────────────── -->
  <div class="section-header" style="margin-bottom:24px;">
    <div>
      <h1 class="page-title">Statistik</h1>
      <p class="page-subtitle">Überblick über Bestände, Auslastung und Produktverteilung</p>
    </div>
  </div>

  <!-- ─── Filter Bar ───────────────────────────────────── -->
  <div class="filter-bar">
    <label for="filterLager"><i class="bi bi-building"></i> Lager:</label>
    <select class="form-select" id="filterLager" style="max-width:220px; height:36px; padding:6px 12px;"
            onchange="applyFilter()">
      <option value="">Alle Lager</option>
      {% for l in lager_stats %}
        <option value="{{ loop.index0 }}">{{ l.lagername }}</option>
      {% endfor %}
    </select>
    <div style="flex:1;"></div>
    <span style="font-size:13px;color:var(--text-muted);">
      Daten aktuell — {{ num_inventar }} Inventareinträge
    </span>
  </div>

  <!-- ─── KPI Cards ─────────────────────────────────────── -->
  <div class="stat-grid">
    <div class="stat-card">
      <i class="bi bi-box-seam stat-icon"></i>
      <div class="stat-value">{{ num_produkte }}</div>
      <div class="stat-label">Produkte gesamt</div>
    </div>
    <div class="stat-card">
      <i class="bi bi-building stat-icon"></i>
      <div class="stat-value">{{ num_lager }}</div>
      <div class="stat-label">Lager gesamt</div>
    </div>
    <div class="stat-card">
      <i class="bi bi-stack stat-icon"></i>
      <div class="stat-value">{{ total_menge }}</div>
      <div class="stat-label">Einheiten gesamt</div>
    </div>
    <div class="stat-card">
      <i class="bi bi-graph-up stat-icon"></i>
      {% if top10_values %}
        <div class="stat-value">{{ top10_values[0] }}</div>
        <div class="stat-label">Höchster Einzelbestand</div>
      {% else %}
        <div class="stat-value">—</div>
        <div class="stat-label">Höchster Einzelbestand</div>
      {% endif %}
    </div>
  </div>

  <!-- ─── Charts (2-column) ────────────────────────────── -->
  <div class="charts-grid">

    <!-- Left: Donut — Distribution per warehouse -->
    <div class="chart-card">
      <div class="chart-title">
        <i class="bi bi-pie-chart-fill"></i> Produktverteilung je Lager
      </div>
      <div class="chart-container">
        <canvas id="donutChart"></canvas>
      </div>
    </div>

    <!-- Right: Bar — Top 10 products by quantity -->
    <div class="chart-card">
      <div class="chart-title">
        <i class="bi bi-bar-chart-fill"></i> Top-Produkte nach Bestand
      </div>
      <div class="chart-container">
        <canvas id="barChart"></canvas>
      </div>
    </div>

    <!-- Left: Capacity utilisation -->
    <div class="chart-card">
      <div class="chart-title">
        <i class="bi bi-speedometer2"></i> Lagerauslastung (%)
      </div>
      <div class="chart-container">
        <canvas id="ausChart"></canvas>
      </div>
    </div>

    <!-- Right: Category distribution -->
    <div class="chart-card">
      <div class="chart-title">
        <i class="bi bi-tags-fill"></i> Kategorieverteilung
      </div>
      <div class="chart-container">
        <canvas id="katChart"></canvas>
      </div>
    </div>

  </div>

  <!-- ─── Top Products Info Section ────────────────────── -->
  <div class="card">
    <div class="section-header" style="margin-bottom:16px;">
      <h2 style="font-size:17px;font-weight:700;margin:0;color:var(--text);">
        <i class="bi bi-trophy" style="color:var(--accent);"></i> Top-Produkte nach Gesamtbestand
      </h2>
      <span class="badge badge-accent">{{ top10_labels | length }} Einträge</span>
    </div>
    <div class="top-list" id="topListContainer"></div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
  let donutChart, barChart, ausChart, katChart;

  // ── Theme-aware colours (red/white) ─────────────────────
  const isLight = document.documentElement.getAttribute('data-theme') === 'light';
  // Helle, kontrastreiche Farben im Dark Mode
  const axisMain   = isLight ? '#111827' : '#f9fafb';   // primary text
  const axisMuted  = isLight ? '#6b7280' : '#e5e7eb';   // secondary text
  const gridColor  = isLight ? '#e5e7eb' : '#374151';   // grid lines
  const borderCol  = isLight ? '#d1d5db' : '#4b5563';   // chart borders
  const surfaceBg  = isLight ? '#f5f5f7' : '#050608';   // page background
  const tooltipBg  = isLight ? '#ffffff' : '#111827';
  const tooltipBor = isLight ? '#d1d5db' : '#4b5563';

  // Palette mit Rot-/Neutral-Tönen
  const palette = [
    '#ef4444','#fecaca','#b91c1c','#fda4af',
    '#991b1b','#fee2e2','#7f1d1d','#f97373',
    '#fca5a5','#450a0a'
  ];

  const chartDefaults = {
    plugins: {
      legend: {
        labels: { color: axisMuted, font: { size: 12 }, boxWidth: 14, padding: 16 }
      },
      tooltip: {
        backgroundColor: tooltipBg,
        borderColor: tooltipBor,
        borderWidth: 1,
        titleColor: axisMain,
        bodyColor: axisMuted,
        padding: 10
      }
    }
  };

  Chart.defaults.color = axisMuted;
  Chart.defaults.borderColor = borderCol;

  // ── Data from Flask ────────────────────────────────────
  const donutLabels = {{ lager_labels | tojson }};
  const donutData   = {{ lager_mengen | tojson }};
  const globalTopLabels = {{ top10_labels | tojson }};
  const globalTopValues = {{ top10_values | tojson }};
  const lagerTopLabels  = {{ lager_top_labels | tojson }};
  const lagerTopValues  = {{ lager_top_values | tojson }};
  const barLabels       = globalTopLabels.slice();
  const barData         = globalTopValues.slice();
  const ausLabels   = {{ aus_labels | tojson }};
  const ausData     = {{ aus_pct | tojson }};
  const katLabels   = {{ kat_labels | tojson }};
  const katData     = {{ kat_counts | tojson }};

  // Basisfarben für Filter-Highlighting
  const donutBaseColors = donutLabels.map((_, i) => palette[i % palette.length]);
  const ausBaseColors   = ausData.map(v =>
    v >= 90 ? '#b91c1ccc' : v >= 70 ? '#f97316cc' : '#22c55ecc'
  );

  // ── Donut chart ────────────────────────────────────────
  donutChart = new Chart(document.getElementById('donutChart'), {
    type: 'doughnut',
    data: {
      labels: donutLabels,
      datasets: [{
        data: donutData,
        backgroundColor: donutBaseColors,
        borderColor: surfaceBg,
        borderWidth: 3,
        hoverOffset: 8
      }]
    },
    options: {
      ...chartDefaults,
      cutout: '65%',
      maintainAspectRatio: false,
    }
  });

  // ── Bar chart (top 10) ─────────────────────────────────
  barChart = new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: barLabels,
      datasets: [{
        label: 'Bestand',
        data: barData,
        backgroundColor: palette[0] + 'dd',
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      ...chartDefaults,
      indexAxis: 'y',
      maintainAspectRatio: false,
      scales: {
        x: { grid: { color: gridColor }, ticks: { color: axisMuted } },
        y: { grid: { display: false },  ticks: { color: axisMain, font: { size: 12 } } }
      }
    }
  });

  // ── Auslastung bar chart ───────────────────────────────
  ausChart = new Chart(document.getElementById('ausChart'), {
    type: 'bar',
    data: {
      labels: ausLabels,
      datasets: [{
        label: 'Auslastung %',
        data: ausData,
        // Grün (niedrig), Gelb (mittel), Rot (hoch)
        backgroundColor: ausBaseColors,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      ...chartDefaults,
      maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: axisMain } },
        y: { grid: { color: gridColor }, ticks: { color: axisMuted },
             max: 100, beginAtZero: true }
      }
    }
  });

  // ── Kategorie donut ────────────────────────────────────
  katChart = new Chart(document.getElementById('katChart'), {
    type: 'pie',
    data: {
      labels: katLabels,
      datasets: [{
        data: katData,
        backgroundColor: palette,
        borderColor: surfaceBg,
        borderWidth: 3,
      }]
    },
    options: {
      ...chartDefaults,
      maintainAspectRatio: false,
    }
  });
  function renderTopList(labels, values) {
    const container = document.getElementById('topListContainer');
    if (!container) return;

    container.innerHTML = '';

    if (!labels || !labels.length) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.style.padding = '40px';
      empty.innerHTML = '<i class="bi bi-inbox"></i><p>Kein Bestand vorhanden.</p>';
      container.appendChild(empty);
      return;
    }

    const maxVal = (values && values.length && values[0] > 0) ? values[0] : 1;

    labels.forEach((name, idx) => {
      const value = values && values[idx] ? values[idx] : 0;
      const item  = document.createElement('div');
      item.className = 'top-item';

      const rank = idx + 1;
      let rankClass = 'top-rank';
      if (rank === 1) rankClass += ' rank-1';
      else if (rank === 2) rankClass += ' rank-2';
      else if (rank === 3) rankClass += ' rank-3';

      const rankDiv = document.createElement('div');
      rankDiv.className = rankClass;
      rankDiv.textContent = String(rank);

      const nameDiv = document.createElement('div');
      nameDiv.className = 'top-item-name';
      nameDiv.textContent = name;

      const valDiv = document.createElement('div');
      valDiv.className = 'top-item-val';
      valDiv.textContent = value + ' Stk.';

      const barWrapper = document.createElement('div');
      barWrapper.style.width = '120px';
      const barBg = document.createElement('div');
      barBg.style.background = 'var(--surface-3)';
      barBg.style.borderRadius = '99px';
      barBg.style.height = '4px';
      barBg.style.overflow = 'hidden';

      const barFill = document.createElement('div');
      barFill.style.height = '100%';
      barFill.style.borderRadius = '99px';
      barFill.style.background = 'var(--accent)';
      barFill.style.width = ((value / maxVal * 100) || 0) + '%';

      barBg.appendChild(barFill);
      barWrapper.appendChild(barBg);

      item.appendChild(rankDiv);
      item.appendChild(nameDiv);
      item.appendChild(valDiv);
      item.appendChild(barWrapper);

      container.appendChild(item);
    });
  }

  // ── Filter (client-side) ──────────────────────────────
  function applyFilter() {
    const select = document.getElementById('filterLager');
    if (!select || !donutChart || !ausChart || !barChart) return;

    const val = select.value;
    const idx = val === '' ? -1 : parseInt(val, 10);

    // Donut: ausgewähltes Lager hervorheben, andere abdunkeln
    donutChart.data.datasets[0].backgroundColor = donutBaseColors.map((c, i) =>
      idx === -1 || i === idx ? c : 'rgba(148,163,184,0.25)'
    );
    donutChart.update();

    // Auslastung: ausgewählte Bar hervorheben
    ausChart.data.datasets[0].backgroundColor = ausBaseColors.map((c, i) =>
      idx === -1 || i === idx ? c : 'rgba(148,163,184,0.25)'
    );
    ausChart.update();

    // Top-Produkte nach Bestand (Chart wird gefiltert)
    if (idx === -1) {
      barChart.data.labels = globalTopLabels;
      barChart.data.datasets[0].data = globalTopValues;
    } else {
      const labels = lagerTopLabels[idx] || [];
      const values = lagerTopValues[idx] || [];
      barChart.data.labels = labels;
      barChart.data.datasets[0].data = values;
    }
    barChart.update();

    // Top-Produkte nach Gesamtbestand (Liste unten bleibt global)
    renderTopList(globalTopLabels, globalTopValues);
  }

  // Initial ohne Filter alles anzeigen
  applyFilter();
</script>
{% endblock %}
