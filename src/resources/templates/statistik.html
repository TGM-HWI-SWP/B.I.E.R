{% extends "layout.html" %}
{% block title %}Statistiken – B.I.E.R{% endblock %}
{% block page_title %}<i class="bi bi-bar-chart-line me-2"></i>Statistiken{% endblock %}
{% block page_subtitle %}Übersicht &amp; Auswertungen auf einen Blick{% endblock %}

{% block content %}
<!-- KPI Cards -->
<div class="row g-4 mb-5">
  <div class="col-sm-6 col-xl-3">
    <div class="card stat-card h-100 shadow-sm p-3">
      <div class="d-flex align-items-center gap-3">
        <i class="icon bi bi-box-seam"></i>
        <div>
          <div class="value">{{ num_produkte }}</div>
          <div class="text-muted small">Produkte gesamt</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="card stat-card h-100 shadow-sm p-3">
      <div class="d-flex align-items-center gap-3">
        <i class="icon bi bi-building"></i>
        <div>
          <div class="value">{{ num_lager }}</div>
          <div class="text-muted small">Lager gesamt</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="card stat-card h-100 shadow-sm p-3">
      <div class="d-flex align-items-center gap-3">
        <i class="icon bi bi-stack"></i>
        <div>
          <div class="value">{{ total_menge | int }}</div>
          <div class="text-muted small">Einheiten auf Lager</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="card stat-card h-100 shadow-sm p-3">
      <div class="d-flex align-items-center gap-3">
        <i class="icon bi bi-clipboard2-data"></i>
        <div>
          <div class="value">{{ num_inventar }}</div>
          <div class="text-muted small">Inventar-Einträge</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Row 1: Lagerbestand per Lager + Kategorieverteilung -->
<div class="row g-4 mb-4">
  <div class="col-lg-7">
    <div class="card section-card shadow-sm h-100">
      <div class="card-header">
        <i class="bi bi-bar-chart me-2"></i>Lagerbestand je Lager
      </div>
      <div class="card-body">
        <canvas id="chartLagerBestand" height="120"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card section-card shadow-sm h-100">
      <div class="card-header">
        <i class="bi bi-pie-chart me-2"></i>Produkte nach Kategorie
      </div>
      <div class="card-body d-flex align-items-center justify-content-center">
        <canvas id="chartKategorie" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Row 2: Top 10 Produkte + Gewichtsverteilung -->
<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="card section-card shadow-sm h-100">
      <div class="card-header">
        <i class="bi bi-trophy me-2"></i>Top 10 Produkte (nach Gesamtbestand)
      </div>
      <div class="card-body">
        <canvas id="chartTop10" height="200"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card section-card shadow-sm h-100">
      <div class="card-header">
        <i class="bi bi-distribute-horizontal me-2"></i>Gewichtsverteilung (Produkte)
      </div>
      <div class="card-body">
        <canvas id="chartGewicht" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Row 3: Auslastung Lager (Doughnut) + Füllstand-Tabelle -->
<div class="row g-4 mb-4">
  <div class="col-lg-4">
    <div class="card section-card shadow-sm h-100">
      <div class="card-header">
        <i class="bi bi-speedometer me-2"></i>Auslastung der Lager
      </div>
      <div class="card-body d-flex align-items-center justify-content-center">
        <canvas id="chartAuslastung" height="220"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card section-card shadow-sm h-100">
      <div class="card-header">
        <i class="bi bi-table me-2"></i>Lager-Füllstand im Detail
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-dark">
            <tr>
              <th>Lager</th>
              <th class="text-center">Produkte</th>
              <th class="text-center">Einheiten</th>
              <th class="text-center">Max. Plätze</th>
              <th>Auslastung</th>
            </tr>
          </thead>
          <tbody>
            {% for row in lager_stats %}
            <tr>
              <td><i class="bi bi-building me-1 text-secondary"></i>{{ row.lagername }}</td>
              <td class="text-center">{{ row.num_produkte }}</td>
              <td class="text-center fw-bold">{{ row.menge }}</td>
              <td class="text-center text-muted">{{ row.max_plaetze }}</td>
              <td style="min-width:140px">
                {% set pct = [[(row.menge / row.max_plaetze * 100) | round(1), 100] | min, 0] | max %}
                <div class="d-flex align-items-center gap-2">
                  <div class="progress flex-grow-1" style="height:10px">
                    <div class="progress-bar {% if pct > 90 %}bg-danger{% elif pct > 60 %}bg-warning{% else %}bg-success{% endif %}"
                         data-pct="{{ pct }}"></div>
                  </div>
                  <span class="small text-muted">{{ pct }}%</span>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart data island: Jinja2 renders valid JSON; VS Code won't JS-lint application/json -->
<script type="application/json" id="bier-chart-data">
{
  "lager_labels":   {{ lager_labels   | tojson }},
  "lager_mengen":   {{ lager_mengen   | tojson }},
  "kat_labels":     {{ kat_labels     | tojson }},
  "kat_counts":     {{ kat_counts     | tojson }},
  "top10_labels":   {{ top10_labels   | tojson }},
  "top10_values":   {{ top10_values   | tojson }},
  "gewicht_bins":   {{ gewicht_bins   | tojson }},
  "gewicht_counts": {{ gewicht_counts | tojson }},
  "aus_labels":     {{ aus_labels     | tojson }},
  "aus_pct":        {{ aus_pct        | tojson }}
}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
// Apply progress-bar widths (avoids Jinja2 in inline CSS)
document.querySelectorAll('.progress-bar[data-pct]').forEach(function(el) {
  el.style.width = el.dataset.pct + '%';
});

// Read chart data from the JSON island
const _cd = JSON.parse(document.getElementById('bier-chart-data').textContent);

const AMBER  = '#e8a020';
const DARK   = '#1a1a2e';
const COLORS = [
  '#e8a020','#1a1a2e','#16213e','#0f3460','#e94560',
  '#4ecca3','#f5a623','#3d5a80','#98c1d9','#e9ecef',
  '#ee6c4d','#293241','#2ec4b6','#ff9f1c','#cbf3f0',
];

Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', sans-serif";

// ── Chart 1: Bestand je Lager (Bar) ───────────────────────────────────────
new Chart(document.getElementById('chartLagerBestand'), {
  type: 'bar',
  data: {
    labels: _cd.lager_labels,
    datasets: [{
      label: 'Einheiten',
      data: _cd.lager_mengen,
      backgroundColor: COLORS.slice(0, _cd.lager_labels.length),
      borderRadius: 6,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
  }
});

// ── Chart 2: Kategorieverteilung (Pie) ────────────────────────────────────
new Chart(document.getElementById('chartKategorie'), {
  type: 'pie',
  data: {
    labels: _cd.kat_labels,
    datasets: [{
      data: _cd.kat_counts,
      backgroundColor: COLORS,
      borderWidth: 2,
      borderColor: '#f5f0e8',
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'right', labels: { boxWidth: 14, font: { size: 12 } } }
    }
  }
});

// ── Chart 3: Top 10 Produkte (Horizontal Bar) ─────────────────────────────
new Chart(document.getElementById('chartTop10'), {
  type: 'bar',
  data: {
    labels: _cd.top10_labels,
    datasets: [{
      label: 'Gesamtbestand',
      data: _cd.top10_values,
      backgroundColor: AMBER,
      borderRadius: 5,
    }]
  },
  options: {
    indexAxis: 'y',
    responsive: true,
    plugins: { legend: { display: false } },
    scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }
  }
});

// ── Chart 4: Gewichtsverteilung (Histogramm) ──────────────────────────────
new Chart(document.getElementById('chartGewicht'), {
  type: 'bar',
  data: {
    labels: _cd.gewicht_bins,
    datasets: [{
      label: 'Produkte',
      data: _cd.gewicht_counts,
      backgroundColor: '#0f3460',
      borderRadius: 4,
      barPercentage: 0.95,
      categoryPercentage: 1.0,
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: 'Anzahl Produkte' } },
      x: { title: { display: true, text: 'Gewicht (kg)' } }
    }
  }
});

// ── Chart 5: Auslastung Lager (Doughnut) ─────────────────────────────────
new Chart(document.getElementById('chartAuslastung'), {
  type: 'doughnut',
  data: {
    labels: _cd.aus_labels,
    datasets: [{
      data: _cd.aus_pct,
      backgroundColor: COLORS,
      borderWidth: 2,
      borderColor: '#f5f0e8',
    }]
  },
  options: {
    responsive: true,
    cutout: '55%',
    plugins: {
      legend: { position: 'bottom', labels: { boxWidth: 14, font: { size: 11 } } },
      tooltip: {
        callbacks: {
          label: function(ctx) { return ' ' + ctx.formattedValue + '%'; }
        }
      }
    }
  }
});
</script>
{% endblock %}
