{% extends "layout.html" %}

{% block title %}Inventar – B.I.E.R{% endblock %}
{% block page_title %}Inventar{% endblock %}
{% block page_subtitle %}Bestandsverwaltung je Lagerstandort{% endblock %}

{% block content %}
{% if not lager_list %}
<!-- No warehouses yet -->
<div class="alert alert-warning">
  Noch keine Lager vorhanden. Bitte zuerst ein
  <a href="/lager" class="alert-link">Lager anlegen</a>.
</div>
{% else %}

<div class="row g-4">
  <!-- Sidebar: warehouse picker -->
  <div class="col-md-3">
    <div class="card section-card">
      <div class="card-header"><i class="bi bi-building me-1"></i>Lager wählen</div>
      <div class="list-group list-group-flush">
        {% for l in lager_list %}
        <a href="/inventar/{{ l._id }}"
           class="list-group-item list-group-item-action {% if selected_lager and selected_lager._id == l._id %}active{% endif %}">
          <i class="bi bi-building me-1"></i>{{ l.lagername }}
          <small class="d-block text-{{ 'white-50' if selected_lager and selected_lager._id == l._id else 'muted' }}">
            Max. {{ l.max_plaetze }} Plätze
          </small>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Main: inventory table for selected warehouse -->
  <div class="col-md-9">
    {% if selected_lager %}
    <div class="card section-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-clipboard-data me-2"></i>{{ selected_lager.lagername }}</span>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalHinzufuegen">
          <i class="bi bi-plus-lg me-1"></i>Produkt hinzufügen
        </button>
      </div>
      <div class="card-body p-0">
        {% if inventar %}
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Produkt</th>
              <th>Beschreibung</th>
              <th style="width:140px">Menge</th>
              <th class="text-end">Aktionen</th>
            </tr>
          </thead>
          <tbody>
            {% for e in inventar %}
            <tr>
              <td class="fw-semibold">{{ e.produkt_name }}</td>
              <td class="text-muted small">{{ e.produkt_beschreibung }}</td>
              <td>
                <!-- Inline quantity update -->
                <form method="POST"
                      action="/inventar/{{ selected_lager._id }}/{{ e.produkt_id }}/aktualisieren"
                      class="d-flex gap-1">
                  <input type="number" name="menge" value="{{ e.menge }}"
                         min="0" class="form-control form-control-sm" style="width:80px">
                  <button type="submit" class="btn btn-sm btn-outline-primary" title="Speichern">
                    <i class="bi bi-check-lg"></i>
                  </button>
                </form>
              </td>
              <td class="text-end">
                <form method="POST"
                      action="/inventar/{{ selected_lager._id }}/{{ e.produkt_id }}/entfernen"
                      onsubmit="return confirm('Produkt aus Inventar entfernen?')">
                  <button type="submit" class="btn btn-sm btn-outline-danger" title="Entfernen">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot class="table-light">
            <tr>
              <td colspan="2" class="text-muted fw-semibold">Gesamt</td>
              <td class="fw-bold">{{ inventar | sum(attribute='menge') }}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
        {% else %}
        <div class="p-4 text-muted text-center">
          Dieses Lager hat noch keine Produkte. Füge das erste hinzu!
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Add product modal -->
    <div class="modal fade" id="modalHinzufuegen" tabindex="-1">
      <div class="modal-dialog">
        <form method="POST" action="/inventar/{{ selected_lager._id }}/hinzufuegen" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Produkt zu „{{ selected_lager.lagername }}" hinzufügen</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            {% if produkte %}
            <div class="mb-3">
              <label class="form-label fw-semibold">Produkt <span class="text-danger">*</span></label>
              <select name="produkt_id" class="form-select" required>
                <option value="" disabled selected>– bitte wählen –</option>
                {% for p in produkte %}
                <option value="{{ p._id }}">{{ p.name }}{% if p.beschreibung %} – {{ p.beschreibung }}{% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Menge</label>
              <input type="number" name="menge" class="form-control" value="1" min="0">
            </div>
            {% else %}
            <div class="alert alert-warning mb-0">
              Noch keine Produkte angelegt. Bitte zuerst
              <a href="/produkte" class="alert-link">Produkte anlegen</a>.
            </div>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
            {% if produkte %}
            <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Hinzufügen</button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}
